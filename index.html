<!doctype html>
<html>
   <head>
    <script type="text/javascript" src="js/three.js"></script>
    <script src="//unpkg.com/three-trackballcontrols-web/dist/three-trackballcontrols.min.js"></script>
    <script type="text/javascript" src="//unpkg.com/three-forcegraph"></script>
    <script src="//unpkg.com/3d-force-graph"></script>
    <script src="//unpkg.com/three-spritetext"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!--script type="text/javascript" src="js/loader.js"></script>
    <script type="text/javascript" src="js/main.js"></script -->
    <link rel="stylesheet" type="text/css" href="css/three.css">
   </head>
   <body style="background-color:black;">
       <div id="config" style="background-color:blue;background-size: 300px 100px, cover;">
                <div>URL: <input type="text" id="url">  <button onclick="reload()">reload</button><br></div>
                <br>
                <select id="graph_type" onchange="changeTypeOfObject()">
                        <option value="sphere">sphere</option>
                        <option value="cube">cube</option>
                        <option value="text">text</option>
                </select>
                
                <select id="graph_link_color"  onchange="changeTypeOfLink()">
                        <option type="number" value='red'>red</option>
                        <option  type="number" value='white'>white</option>
                        <option type="number"  value='brow'>brow</option>
                        <option type="number"  value='pink'>pink</option>
                        <option type="number"  value='brownDark'>brownDark</option>
                        <option  type="number" value='blue'>blue</option>
                </select>
                <select id="graph_line_color"  onchange="changeTypeOfLink()">
                        <option value="0xf25346">red</option>
                        <option value="0xd8d0d1">white</option>
                        <option value="0x59332e">brow</option>
                        <option value="0xF5986E">pink</option>
                        <option value="0x23190f">brownDark</option>
                        <option value="0x68c3c0">blue</option>
                    </select>
                <br>
       </div>
     
       <div id="select" class="row">
            <div class="col-sm-4" style="background-color:gold;margin: 25px;background-size: 300px 100px;"> 
                <p id="source">Source user: click user to choose</p>
                <p id="destination">Destination user: click user to choose</p>
                <input type="button" value="Get way" onclick="getWay()">
            </div>
            <div class="col-sm-4" style="background-color:red;margin: 25px;background-size: 300px 100px;">
                    <p>User detail</p>
                    <p id="selectedNodeName">click on node to show detail</p>
                    <p id="selectedNodeFriends"></p>
                    <p id="selectedNodeGroup"></p>
                </div>
        </div>
       
        <!--div id="world"></div-->
        <div id="3d-graph"></div>

        <script>
            var Colors = {
	            red:0xf25346,
	            white:0xd8d0d1,
	            brown:0x59332e,
	            pink:0xF5986E,
	            brownDark:0x23190f,
	            blue:0x68c3c0,
	        };
            // Gen random data
            var URL='data/miserables.json'
            var loader = new THREE.FileLoader();
            var dataObject;
            var geometry = new THREE.SphereGeometry( 5, 64, 64 );
            var material =  new THREE.MeshPhongMaterial({color:0x00ff00, shading:THREE.FlatShading});
            var sphere = new THREE.Mesh( geometry, material );
            
            var geometry_box = new THREE.BoxGeometry( 10, 10, 10 );
            var cube = new THREE.Mesh( geometry_box, material );
            // select source and des node
            var selectedNode=0,source_node,des_node;
            //var 
            var graph_config={
                'color':Colors.red,
                'type':'sphere'
            };
            var gData,Graph,renderer,scene,camera,tbControls;
            //load a text file and output the result to the console
            loadData();           

            function createGraph(data,config){
            var N = 300;
            gData=data;
            const elem = document.getElementById("3d-graph");
            Graph = ForceGraph3D()
                (elem)
                .graphData(gData)
                .nodeLabel('id')
                .nodeAutoColorBy('group')
                .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
                .onNodeClick(node => {
                // Aim at node from outside it
                   // openMenu(node);
                   console.log("on node click")
                   document.getElementById("selectedNodeName").innerHTML="Name: "+node.id;
                    var friends="Friends: ";
                    for(i=0;i<node.neightbors.length;i++) friends+=", " +node.neightbors[i]
                   document.getElementById("selectedNodeFriends").innerHTML=friends;
                   document.getElementById("selectedNodeGroup").innerHTML="Group: " +node.group;
                   selectedNode++;
                   if(selectedNode==1) {
                       document.getElementById("source").innerHTML="Source user selected: " +node.id;
                        source_node=node;
                    }
                   if(selectedNode==2) {
                       document.getElementById("destination").innerHTML="Destination user selected: " +node.id;
                        des_node=node;
                    }
                   if(selectedNode==3) {
                       selectedNode=0;
                       source_node=null;des_node=null;
                       document.getElementById("source").innerHTML="Source user: click user to choose ";
                       document.getElementById("destination").innerHTML="Destination user: click user to choose ";
                       }
                    const distance = 40;
                    const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                    Graph.cameraPosition(
                        { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
                        node, // lookAt ({ x, y, z })
                        3000  // ms transition duration
                        );
                    
                })
                
                .nodeThreeObject(node => {
                        var material =  new THREE.MeshPhongMaterial({color:node.color, shading:THREE.FlatShading});                   
                        var geometry = new THREE.SphereGeometry( 5, 64, 64 );
                        var sphere = new THREE.Mesh( geometry, material );
                        return sphere;                      
                })
                .linkMaterial(material)
                .linkWidth(1)
                ;


            
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('3d-graph').appendChild(renderer.domElement);
            // Setup scene
             scene = new THREE.Scene();
            scene.add(Graph);
            scene.add(new THREE.AmbientLight(0xF5986E));
            var hemisphereLight = new THREE.HemisphereLight(0xaaaaaa,0x000000, 0.9)
            // Nguồn sáng có hướng tỏa ra từ 1 vị trí nhất định
            // Nó giống như mặt trời, nghĩa là các tia được tạo ra song song với nhau.
            var shadowLight = new THREE.DirectionalLight(0xffffff, .9);
            scene.add(hemisphereLight);
            scene.add(shadowLight)
            // Setup camera
             camera = new THREE.PerspectiveCamera();
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            //camera.lookAt(Graph.position);
            camera.position.z = Math.cbrt(N) * 100;
            // Add camera controls
             tbControls = new TrackballControls(camera, renderer.domElement);
            // Kick-off renderer
            /*    (function animate() { // IIFE
              Graph.tickFrame();
              // Frame cycle
              tbControls.update();
              renderer.render(scene, camera);
              requestAnimationFrame(animate);
            })();*/
        }
        // Define your menu
        var menu = [
            {
                title: 'Item #1',
                action: function(d, i) {
                console.log('Item #1 clicked!');
                console.log('The data for this circle is: ' + d);
            },
            disabled: false // optional, defaults to false
            },
            {
                title: 'Item #2',
                action: function(d, i) {
                console.log('You have clicked the second item!');
                console.log('The data for this circle is: ' + d);
            }
        }
        ]
        var contextDiv;
        function openMenu(node)
        {
            contextDiv = document.select("body").append("div")
                .style("position", "absolute")
                .style("top", event.pageY + 1 + "px")
                .style("left", event.pageX + 1 + "px");
            var contextTable = contextDiv.append("table")
                .style("border", "solid 1px");

                contextTable.append("tr")
                .append("td").text("Expand All").attr("id", "citem1");
                contextTable.append("tr")
                .append("td").text("Item2").attr("id", "citem2");
                contextTable.append("tr")
        .append("td").text("Item3").attr("id", "citem3");
    contextTable.on("click", tableClick);
        }

        function processingData(){
            var nodes=dataObject.nodes;
            var links=dataObject.links;
            for(i=0;i<nodes.length;i++)
            {
               nodes[i].neightbors= new Array();
            } 
            for(i=0;i<links.length;i++)
            {
                var link=links[i];
                var nodeA=nodes.find(x=>x.id==link.source);
                var nodeB=nodes.find(y=>y.id==link.target);
              //  console.log("node: " + i+" " +nodeA.id)
               // console.log("node: "+i+" " +nodeB.id)
                nodeA.neightbors.push(nodeB.id);
                nodeB.neightbors.push(nodeA.id);
            }
            console.log(dataObject);
        }
        function filterByNode(node) {
            let { nodes, links } = Graph.graphData();
            links = links.filter(l => l.source == node || l.target == node); // Remove links attached to node
            nodes = getFriends(node,data);
            Graph.graphData({ nodes, links });
        }
        function init_graph(data,config)
        {

            return graph;
        }
        function getWay()
        {
            if(selectedNode==3){
                return;
            }
            if(selectedNode==2){
                shortestPath(dataObject,source_node,des_node);
            }
        }
        function clearBox(elementID)
            {
                document.getElementById(elementID).innerHTML = "";
            }
        function changeTypeOfObject(){
            var type= document.getElementById("graph_type").value;
            Graph.nodeThreeObject(node => {
                    var material =  new THREE.MeshPhongMaterial({color:node.color, shading:THREE.FlatShading});
                    switch(type) {
                        case 'sphere':
                        //graph_config.type=cube;
                        var geometry = new THREE.SphereGeometry( 5, 64, 64 );
                        //var material =  new THREE.MeshPhongMaterial({color:0x00ff00, shading:THREE.FlatShading});
                        var sphere = new THREE.Mesh( geometry, material );
                        return sphere;
                        break;
                        case 'cube':
                        var geometry_box = new THREE.BoxGeometry( 10, 10, 10 );
                        var cube = new THREE.Mesh( geometry_box, material );
                        return cube;
                        break;
                        default:
                        const sprite = new SpriteText(node.id);
                        sprite.color = node.color;
                        sprite.textHeight = 8;
                        return sprite;
                    }                    
                })
        }

        function changeTypeOfLink(){
            
	        var choosencolor=document.getElementById("graph_link_color").value;	        
            var color;
            switch(choosencolor) {
                case 'red':
                color=Colors.red;
                break;
                case 'white':
                color=Colors.white;
                break;
                case 'brown':
                color=Colors.brown;
                break;
                case 'pink':
                color=Colors.pink;
                break;
                case 'brownDark':
                color=Colors.brownDark;
                break;
                case 'blue':
                color=Colors.blue;
                break;
                default:
                color=Colors.red;
            }
            var material =  new THREE.MeshPhongMaterial({color:color, shading:THREE.FlatShading});
            Graph.linkMaterial(material)

        }
        function loadData(){
            loader.load(
	        // resource URL
	        URL,

	            // onLoad callback
	        function ( data ) {
                dataObject=JSON.parse(data);
                processingData(dataObject);
                createGraph(dataObject,graph_config);
                // Kick-off renderer
            (function animate() { // IIFE
            //  Graph.tickFrame();
              // Frame cycle
              tbControls.update();
              renderer.render(scene, camera);
              requestAnimationFrame(animate);
            })();
	            },

	            // onProgress callback
	        function ( xhr ) {
		        console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
	            },

	            // onError callback
	        function ( err ) {
                document.getElementById('3d-graph').innerHTML="Cannot load data " + err;
		        console.error( 'An error happened' );
	            }
            );
        }
        function reload(){
            URL = document.getElementById("url").value;
            clearBox('3d-graph');
            console.log(URL)
            loadData();
        }

        function shortestPath(graph, source, target) {
            if (source.id == target.id) {   // Delete these four lines if
            print(source.id);          // you want to look for a cycle
            return;                 // when the source is equal to
            }                         // the target.
         /*   var dist=[graph.nodes.length];
            var prev=[graph.nodes.length];
            for(i=0;i<graph.nodes.length;i++){
                dist[i]=100000;
                prev[]
            }*/
            var queue = [ source ],
            visited = { source: true },
            predecessor = {},
            tail = 0;
            while (tail < queue.length) {
                var u = queue[tail++];  // Pop a vertex off the queue.
               // var u= graph.nodes.find(x=>x.id==u.source);
                var neighbors = u.neightbors;
                console.log(u);
                console.log(neighbors);
                for (var i = 0; i < neighbors.length; ++i) {
                    var a = neighbors[i];
                    var v = graph.nodes.find(x=>x.id==a)
                    if (visited[v]) {
                    continue;
                    }
                visited[v] = true;
                if (v === target) {   // Check if the path is complete.
                    var path = [ v ];   // If so, backtrack through the path.
                    while (u !== source) {
                    u = predecessor[u];
                    path.push(u);
                    }
                path.reverse();
                console.log(path.join(' &rarr; '));
                return;
                }
                predecessor[v] = u;
                queue.push(v);
                }
                }
                console.log('there is no path from ' + source + ' to ' + target);
            }

          </script>


   </body>
   
</html>